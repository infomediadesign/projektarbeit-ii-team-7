#include "asset.h"

#include "../platform.h"

#include <stdlib.h>
#include <string.h>

#define STB_IMAGE_IMPLEMENTATION
#define STBI_ONLY_PNG

#ifndef __clang_analyzer__
#include <stb_image.h>
#else
#define STBI_rgb_alpha 4
#endif

// clang-format off
static const u32 missing_texture[256] = {
  0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000,
  0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff,
  0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000,
  0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff,
  0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000,
  0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff,
  0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000,
  0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff,
  0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000,
  0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff,
  0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000,
  0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff,
  0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000,
  0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff,
  0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000,
  0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff, 0xff000000, 0xffff00ff
};
// clang-format on

static const char *search_paths[5] = { "", "./", "../", "../../", "../../../" };

void flip_channels(u32 *data, const u32 size) {
  for (u32 i = 0; i < size; i++)
    data[i] = (data[i] & 0xff00ff00) | ((data[i] & 0x00ff0000) >> 16) | ((data[i] & 0x000000ff) << 16);
}

void asset_find(const char *asset_path, char *out) {
  for (u8 i = 0; i < 5; i++) {
    char final_path[256];

    memset(final_path, 0, 256);

    strcat_s(final_path, 256, search_paths[i]);
    strcat_s(final_path, 256, asset_path);

    if (access(final_path, F_OK) == 0) {
      memset(out, 0, 256);
      strcpy_s(out, 256, final_path);

      return;
    }
  }
}

void asset_load_image(Image *img, const char *asset_path) {
  char image_path[256];

  asset_find(asset_path, image_path);

  img->data = NULL;
  i32 image_width, image_height, _n;

  u8 *data = stbi_load(image_path, &image_width, &image_height, &_n, STBI_rgb_alpha);

  if (data == NULL) {
    printf("Asset not found: %s\n", asset_path);

    data         = (u8 *)calloc(1024, 1);
    image_width  = 16;
    image_height = 16;

    memcpy(data, (u8 *)missing_texture, 1024);
  }

  img->data   = (u32 *)data;
  img->width  = image_width;
  img->height = image_height;

  flip_channels(img->data, image_width * image_height);
}

void asset_unload_image(Image *img) { stbi_image_free(img->data); }
